<Page
    x:Class="SVGPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:c="clr-namespace:ValueConverters;assembly=ValueConverters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
    xmlns:local="clr-namespace:PolyCut"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:pc="clr-namespace:PolyCut.Core;assembly=PolyCut.Core"
    xmlns:polycutShared="clr-namespace:PolyCut.Shared;assembly=PolyCut.Shared"
    xmlns:rc="clr-namespace:PolyCut.RichCanvas;assembly=PolyCut.RichCanvas"
    xmlns:svg="http://sharpvectors.codeplex.com/runtime/"
    xmlns:svgc="http://sharpvectors.codeplex.com/svgc/"
    xmlns:system="clr-namespace:System;assembly=mscorlib"
    xmlns:theme="clr-namespace:Microsoft.Windows.Themes;assembly=PresentationFramework.Aero"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    x:Name="SVGPageView"
    Title="SVGPage"
    Margin="0,5,0,0"
    d:DataContext="{d:DesignInstance Type=local:SVGPageViewModel}"
    d:DesignHeight="1000"
    d:DesignWidth="1000"
    AllowDrop="True"
    Background="{DynamicResource ControlFillColorTertiaryBrush}"
    Drop="Page_Drop"
    ScrollViewer.CanContentScroll="False"
    Unloaded="SVGPageView_Unloaded"
    mc:Ignorable="d">
    <i:Interaction.Triggers>
        <i:EventTrigger EventName="Loaded" SourceObject="{Binding ElementName=SVGPageView}">
            <i:InvokeCommandAction Command="{Binding MainVM.MainViewLoadedCommand}" />
        </i:EventTrigger>
        <i:KeyTrigger Key="Delete" SourceObject="{Binding ElementName=zoomPanControl}">
            <i:InvokeCommandAction Command="{Binding DeleteDrawableElementCommand}" />
        </i:KeyTrigger>
        <i:KeyTrigger Key="OemCloseBrackets" SourceObject="{Binding ElementName=zoomPanControl}">
            <i:InvokeCommandAction Command="{Binding PreviewKeyDownCommand}" CommandParameter="]" />
        </i:KeyTrigger>
        <i:KeyTrigger Key="OemOpenBrackets" SourceObject="{Binding ElementName=zoomPanControl}">
            <i:InvokeCommandAction Command="{Binding PreviewKeyDownCommand}" CommandParameter="[" />
        </i:KeyTrigger>
    </i:Interaction.Triggers>


    <Grid Margin="5,5,10,5">

        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="55" MinWidth="55" />
            <ColumnDefinition Width="*" />
            <ColumnDefinition
                Width="380"
                MinWidth="380"
                MaxWidth="800" />
        </Grid.ColumnDefinitions>
        <GridSplitter
            Width="10"
            Margin="0,0,-10,0"
            Panel.ZIndex="1"
            Background="Transparent"
            IsTabStop="False"
            ResizeDirection="Columns" />


        <ui:Card
            Grid.Column="0"
            Margin="5,5,0,5"
            Padding="0"
            HorizontalAlignment="Stretch"
            VerticalAlignment="Stretch"
            HorizontalContentAlignment="Center"
            VerticalContentAlignment="Top">
            <local:ToolSelectorPane x:Name="ToolSelectorPanel" />
        </ui:Card>








        <ui:Card
            Grid.Column="1"
            Height="50"
            Margin="5"
            Padding="8"
            HorizontalAlignment="Left"
            VerticalAlignment="Top"
            Panel.ZIndex="20"
            Background="{DynamicResource ControlAltFillColorQuarternaryBrush}"
            Visibility="{Binding CanvasToolModeIsText, Converter={StaticResource BooleanToVisibilityConverter}}">

            <StackPanel Orientation="Horizontal">
                <Label
                    Margin="0,2,10,0"
                    VerticalAlignment="Center"
                    Content="Font" />
                <local:FontPickerComboBox Width="200" SelectedFont="{Binding CanvasFontFamily, Mode=TwoWay}" />
                <Separator Margin="5,0" />
                <Label
                    Margin="0,2,10,0"
                    VerticalAlignment="Center"
                    Content="Size (pt)" />
                <ComboBox
                    Width="80"
                    Padding="7"
                    Background="Transparent"
                    IsEditable="True"
                    SelectedIndex="6"
                    Text="{Binding CanvasFontSize, Mode=OneWayToSource}">
                    <ComboBoxItem Content="3" />
                    <ComboBoxItem Content="4" />
                    <ComboBoxItem Content="6" />
                    <ComboBoxItem Content="8" />
                    <ComboBoxItem Content="10" />
                    <ComboBoxItem Content="12" />
                    <ComboBoxItem Content="14" />
                    <ComboBoxItem Content="16" />
                    <ComboBoxItem Content="18" />
                    <ComboBoxItem Content="20" />
                    <ComboBoxItem Content="24" />
                    <ComboBoxItem Content="28" />
                    <ComboBoxItem Content="32" />
                    <ComboBoxItem Content="36" />
                    <ComboBoxItem Content="48" />
                    <ComboBoxItem Content="72" />
                </ComboBox>
            </StackPanel>
        </ui:Card>

        <rc:ZoomBorder
            x:Name="zoomPanControl"
            Grid.Column="1"
            Background="Transparent"
            CanvasMode="{Binding CanvasToolMode, Mode=OneWay}"
            CanvasTextBox="{Binding CanvasTextBox}"
            ClipToBounds="True"
            Cursor="{Binding CanvasToolMode, Converter={StaticResource CanvasToolModeCursorConverter}, Mode=OneWay}"
            LeftButtonAction="None"
            MiddleButtonAction="Move"
            PreviewMouseDown="zoomPanControl_PreviewMouseDown"
            RightButtonAction="Reset"
            ScaleAmount="0.002"
            ScaleMax="150"
            ScaleMin="0.1">


            <Grid HorizontalAlignment="Center" VerticalAlignment="Center">
                <AdornerDecorator>
                    <rc:PolyCanvas
                        x:Name="mainCanvas"
                        Width="{Binding MainVM.Printer.BedWidth, Mode=TwoWay}"
                        Height="{Binding MainVM.Printer.BedHeight, Mode=TwoWay}"
                        Margin="0,0,0,0"
                        ChildrenCollection="{Binding MainVM.DrawableCollection}"
                        ClipToBounds="False">
                        <rc:PolyCanvas.Background>
                            <DrawingBrush
                                Stretch="None"
                                TileMode="Tile"
                                Viewport="{Binding DataContext.GridViewport, ElementName=SVGPageView}"
                                ViewportUnits="Absolute">
                                <DrawingBrush.Drawing>
                                    <GeometryDrawing>
                                        <GeometryDrawing.Geometry>
                                            <GeometryGroup>
                                                <LineGeometry StartPoint="0,0" EndPoint="{Binding DataContext.GridLineVerticalEnd, ElementName=SVGPageView}" />
                                                <LineGeometry StartPoint="0,0" EndPoint="{Binding DataContext.GridLineHorizontalEnd, ElementName=SVGPageView}" />
                                            </GeometryGroup>
                                        </GeometryDrawing.Geometry>
                                        <GeometryDrawing.Pen>
                                            <Pen Brush="{Binding DataContext.GridLineBrush, ElementName=SVGPageView}" Thickness="{Binding DataContext.GridLineThickness, ElementName=SVGPageView}" />
                                        </GeometryDrawing.Pen>
                                    </GeometryDrawing>
                                </DrawingBrush.Drawing>
                            </DrawingBrush>
                        </rc:PolyCanvas.Background>
                    </rc:PolyCanvas>

                </AdornerDecorator>



                <Canvas
                    Width="{Binding MainVM.Printer.BedWidth, Mode=TwoWay}"
                    Height="{Binding MainVM.Printer.BedHeight, Mode=TwoWay}"
                    Panel.ZIndex="-1"
                    IsHitTestVisible="False">

                    <Border
                        x:Name="DupCuttingMatBounds"
                        Width="{Binding MainVM.Printer.BedWidth, Mode=TwoWay}"
                        Height="{Binding MainVM.Printer.BedHeight, Mode=TwoWay}"
                        Panel.ZIndex="20"
                        IsHitTestVisible="False"
                        Opacity="0">

                        <svgc:SvgCanvas
                            x:Name="DupCuttingMat"
                            HorizontalAlignment="{Binding MainVM.Printer.CuttingMatHorizontalAlignment}"
                            VerticalAlignment="{Binding MainVM.Printer.CuttingMatVerticalAlignment}"
                            Source="{Binding MainVM.Printer.CuttingMat.QualifiedSVGSource}">
                            <svgc:SvgCanvas.RenderTransform>
                                <TransformGroup>
                                    <RotateTransform Angle="{Binding MainVM.Printer.CuttingMatRotation}" />
                                    <TranslateTransform X="{Binding ElementName=CuttingMat_RenderTransform, Path=X}" Y="{Binding ElementName=CuttingMat_RenderTransform, Path=Y}" />
                                </TransformGroup>
                            </svgc:SvgCanvas.RenderTransform>
                        </svgc:SvgCanvas>

                    </Border>
                    <Border
                        x:Name="CuttingMatBounds"
                        Width="{Binding MainVM.Printer.BedWidth, Mode=TwoWay}"
                        Height="{Binding MainVM.Printer.BedHeight, Mode=TwoWay}"
                        Background="{Binding CanvasThemeColor}"
                        BorderBrush="#858585"
                        BorderThickness="1"
                        ClipToBounds="True"
                        CornerRadius="0,0,0,0">
                        <svgc:SvgCanvas
                            x:Name="CuttingMat"
                            Margin="-1"
                            HorizontalAlignment="{Binding MainVM.Printer.CuttingMatHorizontalAlignment}"
                            VerticalAlignment="{Binding MainVM.Printer.CuttingMatVerticalAlignment}"
                            EnsureViewboxSize="False"
                            Source="{Binding MainVM.Printer.CuttingMat.QualifiedSVGSource}"
                            Visibility="{Binding MainVM.CuttingMatVisibility, Converter={StaticResource BoolToVisibilityConverter}}">
                            <svgc:SvgCanvas.RenderTransform>
                                <TransformGroup>
                                    <RotateTransform Angle="{Binding MainVM.Printer.CuttingMatRotation}" />
                                    <TranslateTransform x:Name="CuttingMat_RenderTransform" X="0" Y="0" />
                                </TransformGroup>
                            </svgc:SvgCanvas.RenderTransform>
                        </svgc:SvgCanvas>

                    </Border>


                    <!--  Fill the offset outside space  -->
                    <Path
                        Canvas.Left="0"
                        Canvas.Bottom="0"
                        ClipToBounds="True"
                        IsHitTestVisible="False"
                        StrokeThickness="0.5"
                        Visibility="{Binding MainVM.WorkingAreaVisibility, Converter={StaticResource BoolToVisibilityConverter}}">
                        <Path.Data>
                            <CombinedGeometry GeometryCombineMode="Xor">
                                <CombinedGeometry.Geometry1>
                                    <RectangleGeometry Rect="{Binding MainVM.Printer.BedRect}" />
                                </CombinedGeometry.Geometry1>
                                <CombinedGeometry.Geometry2>
                                    <RectangleGeometry Rect="{Binding MainVM.Printer.WorkingRect}" />
                                </CombinedGeometry.Geometry2>
                            </CombinedGeometry>
                        </Path.Data>
                        <Path.Fill>
                            <LinearGradientBrush SpreadMethod="Reflect" StartPoint="0 0" EndPoint="0.01 0.01">
                                <GradientStop Offset="0.5" Color="#30FFFFFF" />
                                <GradientStop Offset="0.5" Color="#40FFFFFF" />
                            </LinearGradientBrush>
                            <!--<SolidColorBrush Color="#40000000"/>-->
                        </Path.Fill>
                        <Path.Stroke>
                            <SolidColorBrush Color="Transparent" />
                        </Path.Stroke>

                        <Path.Effect>
                            <DropShadowEffect
                                BlurRadius="15"
                                Direction="0"
                                RenderingBias="Quality"
                                ShadowDepth="0" />

                        </Path.Effect>
                        <Path.LayoutTransform>
                            <ScaleTransform ScaleY="-1" />
                        </Path.LayoutTransform>
                    </Path>

                </Canvas>


            </Grid>


        </rc:ZoomBorder>



























        <GridSplitter
            Grid.Column="1"
            Width="10"
            Margin="0,0,-10,0"
            Panel.ZIndex="1"
            Background="Transparent"
            IsTabStop="False"
            ResizeDirection="Columns" />

        <ui:Card
            Grid.Column="2"
            Margin="0"
            Padding="0"
            VerticalAlignment="Stretch"
            VerticalContentAlignment="Stretch"
            Background="Transparent"
            BorderThickness="0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <ui:Card
                    Grid.Row="0"
                    Margin="5,5,0,0"
                    Padding="20,10"
                    VerticalAlignment="Stretch"
                    VerticalContentAlignment="Stretch">
                    <StackPanel Grid.Row="0" Orientation="Vertical">
                        <Grid Margin="0,0" FlowDirection="LeftToRight">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="auto" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="240" />
                            </Grid.ColumnDefinitions>
                            <Label
                                Padding="1,2,0,0"
                                VerticalAlignment="Center"
                                Content="Printer" />
                            <Grid Grid.Column="2" Margin="10,0,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="auto" />
                                </Grid.ColumnDefinitions>
                                <ComboBox
                                    Grid.Column="0"
                                    Background="Transparent"
                                    DisplayMemberPath="Name"
                                    ItemsSource="{Binding MainVM.Printers}"
                                    SelectedItem="{Binding MainVM.Printer}" />
                                <ui:Button
                                    Grid.Column="1"
                                    Width="25"
                                    Height="35"
                                    Margin="-55,0,-10,0"
                                    Padding="0"
                                    Background="Transparent"
                                    BorderBrush="Transparent"
                                    Command="{Binding MainVM.ConfigurePrinterCommand}"
                                    CommandParameter="Ender 3 S1">
                                    <ui:SymbolIcon Margin="0" Symbol="Settings24" />
                                </ui:Button>


                            </Grid>

                        </Grid>

                    </StackPanel>
                </ui:Card>

                <ui:Card
                    Grid.Row="1"
                    Margin="5,5,0,5"
                    VerticalAlignment="Stretch"
                    VerticalContentAlignment="Stretch">
                    <ui:Card.Background>
                        <SolidColorBrush Color="{StaticResource CardBackgroundFillColorDefault}" />
                    </ui:Card.Background>
                    <local:MainSidebar x:Name="MainSidebar" />




                </ui:Card>

            </Grid>

        </ui:Card>


    </Grid>

</Page>
